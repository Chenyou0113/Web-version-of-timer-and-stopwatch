<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢¼è¡¨èˆ‡å€’æ•¸è¨ˆæ™‚å™¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šç¾©å­—é«”ç‚º Inter */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f4f8; /* æ·ºè‰²èƒŒæ™¯ */
        }
        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ä¸Šä¸‹ç®­é ­ (é›–ç„¶å·²ç§»é™¤ input[type="number"], ä½†ä¿ç•™ä»¥é˜²è¬ä¸€) */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* æ·±è‰²æ¨¡å¼æ¨£å¼ */
        html.dark {
            background-color: #1a202c; /* æ·±è‰²èƒŒæ™¯ */
        }
        html.dark .bg-white {
            background-color: #2d3748; /* æ·±è‰²å¡ç‰‡èƒŒæ™¯ */
        }
        html.dark .text-gray-800,
        html.dark .text-gray-900 {
            color: #e2e8f0; /* æ·ºè‰²æ–‡å­— */
        }
        html.dark .bg-gray-50 {
            background-color: #4a5568; /* æ·±è‰²ç¢¼è¡¨é¡¯ç¤ºå€èƒŒæ™¯ */
            border-color: #6a7280; /* æ·±è‰²é‚Šæ¡† */
        }
        html.dark .text-gray-600 {
            color: #a0aec0; /* æ·ºè‰²å–®ä½æ–‡å­— */
        }
        html.dark .bg-gray-100 {
            background-color: #2d3748; /* æ·±è‰²åŠŸèƒ½åˆ—èƒŒæ™¯ */
        }
        html.dark .text-gray-700 {
            color: #e2e8f0; /* æ·±è‰²æ¨¡å¼ä¸‹åŠŸèƒ½åˆ—æŒ‰éˆ•æ–‡å­— */
        }
        html.dark .hover\:bg-gray-200:hover {
            background-color: #4a5568; /* æ·±è‰²æ¨¡å¼ä¸‹åŠŸèƒ½åˆ—æŒ‰éˆ• hover æ•ˆæœ */
        }
        html.dark .bg-blue-50 {
            background-color: #2c5282; /* æ·±è‰²å€’æ•¸è¨ˆæ™‚è¨­å®šå€èƒŒæ™¯ */
            border-color: #4299e1; /* æ·±è‰²å€’æ•¸è¨ˆæ™‚è¨­å®šå€é‚Šæ¡† */
        }
        html.dark .text-blue-800 {
            color: #bee3f8; /* æ·±è‰²å€’æ•¸è¨ˆæ™‚è¨­å®šå€æ–‡å­— */
        }
        html.dark .border-gray-300 {
            border-color: #4a5568; /* æ·±è‰²è¼¸å…¥æ¡†é‚Šæ¡† */
        }
        html.dark .text-center {
            color: #e2e8f0; /* æ·±è‰²è¼¸å…¥æ¡†æ–‡å­— */
        }
        html.dark .focus\:ring-blue-500:focus {
            --tw-ring-color: #63b3ed; /* æ·±è‰²æ¨¡å¼ä¸‹è¼¸å…¥æ¡† focus ring */
        }
        /* æ–°å¢çš„æ·±è‰²æ¨¡å¼æ¨£å¼ for arrows */
        html.dark .arrow-button {
            color: #90cdf4; /* Light blue for arrows in dark mode */
        }
        html.dark .arrow-button:hover {
            color: #bee3f8;
        }
        html.dark .selected-input {
            border-color: #63b3ed; /* Highlight color for selected input in dark mode */
            box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.75); /* Ring effect */
        }
        html.dark #currentTimeDisplay {
            color: #e2e8f0; /* æ·±è‰²æ¨¡å¼ä¸‹ç•¶å‰æ™‚é–“é¡¯ç¤ºæ–‡å­— */
        }

        /* æ•¸å­—å½ˆè·³å‹•ç•« */
        .digit-pop {
            animation: pop-digit 0.3s ease-out;
        }

        @keyframes pop-digit {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; } /* ç¨å¾®æ”¾å¤§æ›´å¤š */
            100% { transform: scale(1); opacity: 1; }
        }

        /* å•Ÿå‹•æ™‚çš„æ•´é«”æ”¾å¤§å‹•ç•« */
        .initial-magnify {
            animation: initial-magnify-animation 0.5s ease-out;
        }

        @keyframes initial-magnify-animation {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; } /* ç¨å¾®æ”¾å¤§æ•´å€‹é¡¯ç¤ºå€ */
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">ç¢¼è¡¨èˆ‡å€’æ•¸è¨ˆæ™‚å™¨</h1>

        <!-- åŠŸèƒ½åˆ— -->
        <div class="flex justify-center mb-8 bg-gray-100 p-2 rounded-lg">
            <button id="showStopwatchButton" class="flex-1 py-2 px-4 rounded-md text-lg font-semibold transition duration-300 ease-in-out mr-2 bg-blue-600 text-white shadow-md">
                ç¢¼è¡¨
            </button>
            <button id="showCountdownButton" class="flex-1 py-2 px-4 rounded-md text-lg font-semibold transition duration-300 ease-in-out ml-2 text-gray-700 hover:bg-gray-200">
                å€’æ•¸è¨ˆæ™‚
            </button>
        </div>

        <!-- ç¢¼è¡¨æ¨¡å¼å€å¡Š -->
        <div id="stopwatchSection">
            <!-- ç¢¼è¡¨é¡¯ç¤ºå€ -->
            <div id="timerDisplay" class="flex justify-center items-baseline text-center mb-8 p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                <div class="flex flex-col items-center mx-1">
                    <span id="displayHours" class="text-6xl font-mono text-gray-900">00</span>
                    <span class="text-sm text-gray-600">å°æ™‚</span>
                </div>
                <span class="text-6xl font-mono text-gray-900 mx-1">:</span>
                <div class="flex flex-col items-center mx-1">
                    <span id="displayMinutes" class="text-6xl font-mono text-gray-900">00</span>
                    <span class="text-sm text-gray-600">åˆ†é˜</span>
                </div>
                <span class="text-6xl font-mono text-gray-900 mx-1">:</span>
                <div class="flex flex-col items-center mx-1">
                    <span id="displaySeconds" class="text-6xl font-mono text-gray-900">00</span>
                    <span class="text-sm text-gray-600">ç§’</span>
                </div>
                <span class="text-6xl font-mono text-gray-900 mx-1">.</span>
                <div class="flex flex-col items-center mx-1">
                    <span id="displayMilliseconds" class="text-4xl font-mono text-gray-900">00</span> <!-- æ¯«ç§’é¡¯ç¤ºå…©ä½æ•¸å­— -->
                </div>
            </div>
        </div>

        <!-- å€’æ•¸è¨ˆæ™‚æ¨¡å¼å€å¡Š -->
        <div id="countdownSection" class="hidden">
            <!-- å€’æ•¸è¨ˆæ™‚è¨­å®šå€ -->
            <div class="mb-8 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                <div class="flex justify-center items-center space-x-2 mb-4">
                    <!-- å°æ™‚è¼¸å…¥å€ -->
                    <div class="flex flex-col items-center">
                        <button class="arrow-button text-xl font-bold text-blue-600 hover:text-blue-800" data-unit="hours" data-action="increment">â–²</button>
                        <span id="countdownHoursDisplay" class="w-16 p-4 border border-gray-300 rounded-md text-center text-lg cursor-pointer countdown-input-display">00</span>
                        <button class="arrow-button text-xl font-bold text-blue-600 hover:text-blue-800" data-unit="hours" data-action="decrement">â–¼</button>
                    </div>
                    <span class="text-2xl font-bold">:</span>
                    <!-- åˆ†é˜è¼¸å…¥å€ -->
                    <div class="flex flex-col items-center">
                        <button class="arrow-button text-xl font-bold text-blue-600 hover:text-blue-800" data-unit="minutes" data-action="increment">â–²</button>
                        <span id="countdownMinutesDisplay" class="w-16 p-4 border border-gray-300 rounded-md text-center text-lg cursor-pointer countdown-input-display">00</span>
                        <button class="arrow-button text-xl font-bold text-blue-600 hover:text-blue-800" data-unit="minutes" data-action="decrement">â–¼</button>
                    </div>
                    <span class="text-2xl font-bold">:</span>
                    <!-- ç§’è¼¸å…¥å€ -->
                    <div class="flex flex-col items-center">
                        <button class="arrow-button text-xl font-bold text-blue-600 hover:text-blue-800" data-unit="seconds" data-action="increment">â–²</button>
                        <span id="countdownSecondsDisplay" class="w-16 p-4 border border-gray-300 rounded-md text-center text-lg cursor-pointer countdown-input-display">00</span>
                        <button class="arrow-button text-xl font-bold text-blue-600 hover:text-blue-800" data-unit="seconds" data-action="decrement">â–¼</button>
                    </div>
                </div>

                <!-- æ•¸å­—å°éµç›¤å·²ç§»é™¤ -->
                <!-- <div id="keypad" class="grid grid-cols-3 gap-2 mt-4 hidden">
                    <button class="keypad-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg shadow-sm transition duration-150 ease-in-out" data-digit="1">1</button>
                    <button class="keypad-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg shadow-sm transition duration-150 ease-in-out" data-digit="2">2</button>
                    <button class="keypad-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg shadow-sm transition duration-150 ease-in-out" data-digit="3">3</button>
                    <button class="keypad-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg shadow-sm transition duration-150 ease-in-out" data-digit="4">4</button>
                    <button class="keypad-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg shadow-sm transition duration-150 ease-in-out" data-digit="5">5</button>
                    <button class="keypad-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg shadow-sm transition duration-150 ease-in-out" data-digit="6">6</button>
                    <button class="keypad-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg shadow-sm transition duration-150 ease-in-out" data-digit="7">7</button>
                    <button class="keypad-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg shadow-sm transition duration-150 ease-in-out" data-digit="8">8</button>
                    <button class="keypad-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg shadow-sm transition duration-150 ease-in-out" data-digit="9">9</button>
                    <button id="clearKeypad" class="keypad-button bg-red-400 hover:bg-red-500 text-white font-bold py-3 rounded-lg shadow-sm transition duration-150 ease-in-out">C</button>
                    <button class="keypad-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg shadow-sm transition duration-150 ease-in-out" data-digit="0">0</button>
                    <button id="backspaceKeypad" class="keypad-button bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 rounded-lg shadow-sm transition duration-150 ease-in-out">â†</button>
                </div> -->
            </div>
        </div>


        <!-- æ§åˆ¶æŒ‰éˆ•å€ -->
        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="toggleStartPauseButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                é–‹å§‹
            </button>
            <button id="resetButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                é‡è¨­
            </button>
        </div>
    </div>

    <!-- æ·ºè‰²/æ·±è‰²æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
    <button id="themeToggleButton" class="fixed bottom-4 right-4 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
        ğŸŒ™
    </button>

    <script>
        // ç²å– DOM å…ƒç´ 
        const timerDisplay = document.getElementById('timerDisplay');
        const displayHours = document.getElementById('displayHours');
        const displayMinutes = document.getElementById('displayMinutes');
        const displaySeconds = document.getElementById('displaySeconds');
        const displayMilliseconds = document.getElementById('displayMilliseconds');

        const toggleStartPauseButton = document.getElementById('toggleStartPauseButton'); // åˆä½µå¾Œçš„é–‹å§‹/æš«åœæŒ‰éˆ•
        const resetButton = document.getElementById('resetButton');

        // æ–°çš„å€’æ•¸è¨ˆæ™‚é¡¯ç¤ºå…ƒç´ 
        const countdownHoursDisplay = document.getElementById('countdownHoursDisplay');
        const countdownMinutesDisplay = document.getElementById('countdownMinutesDisplay');
        const countdownSecondsDisplay = document.getElementById('countdownSecondsDisplay');

        const stopwatchSection = document.getElementById('stopwatchSection');
        const countdownSection = document.getElementById('countdownSection');
        const showStopwatchButton = document.getElementById('showStopwatchButton');
        const showCountdownButton = document.getElementById('showCountdownButton');
        const themeToggleButton = document.getElementById('themeToggleButton');

        // const keypad = document.getElementById('keypad'); // å·²ç§»é™¤
        // const clearKeypadButton = document.getElementById('clearKeypad'); // å·²ç§»é™¤
        // const backspaceKeypadButton = document.getElementById('backspaceKeypad'); // å·²ç§»é™¤

        let startTime; // è¨˜éŒ„ç¢¼è¡¨æˆ–å€’æ•¸è¨ˆæ™‚å™¨é–‹å§‹çš„æ™‚é–“æˆ³
        let elapsedTime = 0; // è¨˜éŒ„ç¢¼è¡¨å·²éçš„æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
        let countdownTotalDuration = 0; // å€’æ•¸è¨ˆæ™‚å™¨è¨­å®šçš„ç¸½æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
        let countdownRemainingAtPause = 0; // å€’æ•¸è¨ˆæ™‚å™¨æš«åœæ™‚çš„å‰©é¤˜æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
        let countdownTargetTime; // å€’æ•¸è¨ˆæ™‚å™¨çµæŸçš„ç›®æ¨™æ™‚é–“æˆ³
        let timerInterval; // å„²å­˜ setInterval çš„ IDï¼Œç”¨æ–¼æ¸…é™¤ç¢¼è¡¨
        let isRunning = false; // æ¨™è¨˜ç¢¼è¡¨æ˜¯å¦æ­£åœ¨é‹è¡Œ
        let mode = 'stopwatch'; // 'stopwatch' æˆ– 'countdown'ï¼Œé è¨­ç‚ºç¢¼è¡¨æ¨¡å¼

        // æ•¸å­—å°éµç›¤ç›¸é—œè®Šæ•¸ (å·²ç§»é™¤ç›¸é—œåŠŸèƒ½ï¼Œä½†ä¿ç•™è®Šæ•¸ä»¥é˜²è¬ä¸€)
        let activeInputSpan = null; // é è¨­æ²’æœ‰é¸ä¸­ä»»ä½•è¼¸å…¥æ¡†
        let currentInputString = ''; // ç”¨æ–¼æ§‹å»ºæ•¸å­—è¼¸å…¥

        /**
         * æ›´æ–°ç¢¼è¡¨é¡¯ç¤ºçš„å…§å®¹ï¼ˆå°æ™‚ã€åˆ†é˜ã€ç§’ã€æ¯«ç§’ï¼‰ï¼Œä¸¦è§¸ç™¼æ•¸å­—å‹•ç•«
         * @param {number} milliseconds - è¦é¡¯ç¤ºçš„ç¸½æ¯«ç§’æ•¸
         */
        function updateDisplayContent(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const ms = milliseconds % 1000;

            // ç²å–èˆŠçš„é¡¯ç¤ºå€¼
            const oldHours = displayHours.textContent;
            const oldMinutes = displayMinutes.textContent;
            const oldSeconds = displaySeconds.textContent;
            const oldMilliseconds = displayMilliseconds.textContent;

            // æ ¼å¼åŒ–æ–°çš„é¡¯ç¤ºå€¼
            const newHours = String(hours).padStart(2, '0');
            const newMinutes = String(minutes).padStart(2, '0');
            const newSeconds = String(seconds).padStart(2, '0');
            const newMilliseconds = String(Math.floor(ms / 10)).padStart(2, '0');

            // æ¯”è¼ƒä¸¦æ›´æ–°ï¼Œå¦‚æœæ•¸å­—æ”¹è®Šå‰‡è§¸ç™¼å‹•ç•«
            if (oldHours !== newHours) {
                displayHours.textContent = newHours;
                displayHours.classList.add('digit-pop');
                setTimeout(() => displayHours.classList.remove('digit-pop'), 300); // å‹•ç•«æŒçºŒæ™‚é–“
            }
            if (oldMinutes !== newMinutes) {
                displayMinutes.textContent = newMinutes;
                displayMinutes.classList.add('digit-pop');
                setTimeout(() => displayMinutes.classList.remove('digit-pop'), 300);
            }
            if (oldSeconds !== newSeconds) {
                displaySeconds.textContent = newSeconds;
                displaySeconds.classList.add('digit-pop');
                setTimeout(() => displaySeconds.classList.remove('digit-pop'), 300);
            }
            if (oldMilliseconds !== newMilliseconds) {
                displayMilliseconds.textContent = newMilliseconds;
                displayMilliseconds.classList.add('digit-pop');
                setTimeout(() => displayMilliseconds.classList.remove('digit-pop'), 300);
            }
        }

        /**
         * æ›´æ–°ç¢¼è¡¨é¡¯ç¤ºï¼ˆç¢¼è¡¨æ¨¡å¼ï¼‰
         */
        function updateStopwatch() {
            const currentTime = Date.now();
            elapsedTime = currentTime - startTime;
            updateDisplayContent(elapsedTime);
        }

        /**
         * æ›´æ–°ç¢¼è¡¨é¡¯ç¤ºï¼ˆå€’æ•¸è¨ˆæ™‚æ¨¡å¼ï¼‰
         */
        function updateCountdown() {
            let currentRemaining = countdownTargetTime - Date.now();

            if (currentRemaining <= 0) {
                currentRemaining = 0;
                clearInterval(timerInterval);
                isRunning = false;
                updateDisplayContent(0); // ç¢ºä¿é¡¯ç¤ºç‚º 00:00:00.000
                displayMessage("æ™‚é–“åˆ°ï¼", true); // é¡¯ç¤ºæ™‚é–“åˆ°çš„è¨Šæ¯ï¼Œè‡ªå‹•éš±è—
                // é‡ç½®æŒ‰éˆ•ç‹€æ…‹å’Œå€’æ•¸è¨ˆæ™‚è®Šæ•¸
                toggleStartPauseButton.textContent = 'é–‹å§‹'; // é‡è¨­ç‚ºé–‹å§‹
                toggleStartPauseButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                toggleStartPauseButton.classList.add('bg-green-600', 'hover:bg-green-700');
                countdownTotalDuration = 0; // æ¸…é™¤ç¸½æ™‚é–“
                countdownRemainingAtPause = 0; // æ¸…é™¤å·²é‹è¡Œçš„æ™‚é–“
                return;
            }
            updateDisplayContent(currentRemaining);
        }

        /**
         * åˆ‡æ›é–‹å§‹/æš«åœç‹€æ…‹
         */
        function toggleStartPause() {
            if (!isRunning) {
                // å¾åœæ­¢æˆ–æš«åœç‹€æ…‹é–‹å§‹
                if (mode === 'stopwatch') {
                    startTime = Date.now() - elapsedTime; // å¾ä¸Šæ¬¡åœæ­¢çš„æ™‚é–“é»ç¹¼çºŒ
                    timerInterval = setInterval(updateStopwatch, 10);
                } else { // countdown mode
                    // æª¢æŸ¥æ˜¯å¦æ²’æœ‰è¨­å®šæ™‚é–“æˆ–å€’æ•¸å·²çµæŸ
                    if (countdownTotalDuration <= 0 && countdownRemainingAtPause <= 0) {
                        displayMessage("è«‹å…ˆè¨­å®šå€’æ•¸æ™‚é–“ï¼", true);
                        return;
                    }
                    if (countdownRemainingAtPause <= 0) { // å¦‚æœå‰©é¤˜æ™‚é–“ç‚º0ï¼Œè¡¨ç¤ºå·²ç¶“å€’æ•¸å®Œç•¢
                         displayMessage("å€’æ•¸å·²çµæŸï¼Œè«‹é‡è¨­ï¼", true);
                         return;
                    }
                    // è¨­ç½®å€’æ•¸ç›®æ¨™æ™‚é–“ï¼šç•¶å‰æ™‚é–“ + æš«åœæ™‚çš„å‰©é¤˜æ™‚é–“
                    countdownTargetTime = Date.now() + countdownRemainingAtPause;
                    timerInterval = setInterval(updateCountdown, 10);

                    // æ–°å¢ï¼šå•Ÿå‹•æ™‚çš„æ•´é«”æ”¾å¤§å‹•ç•«
                    timerDisplay.classList.add('initial-magnify');
                    setTimeout(() => {
                        timerDisplay.classList.remove('initial-magnify');
                    }, 500); // å‹•ç•«æŒçºŒæ™‚é–“
                }
                isRunning = true;
                toggleStartPauseButton.textContent = 'æš«åœ';
                toggleStartPauseButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                toggleStartPauseButton.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                hideMessage(); // é–‹å§‹è¨ˆæ™‚æ™‚éš±è—ä»»ä½•æç¤ºè¨Šæ¯
            } else {
                // å¾é‹è¡Œç‹€æ…‹æš«åœ
                clearInterval(timerInterval); // æ¸…é™¤ç¢¼è¡¨
                isRunning = false;
                if (mode === 'stopwatch') {
                    elapsedTime = Date.now() - startTime; // è¨˜éŒ„ç•¶å‰å·²é€æ™‚é–“
                } else { // countdown mode
                    // è¨˜éŒ„ç•¶å‰å‰©é¤˜æ™‚é–“
                    countdownRemainingAtPause = countdownTargetTime - Date.now();
                }
                toggleStartPauseButton.textContent = 'é–‹å§‹';
                toggleStartPauseButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                toggleStartPauseButton.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        }

        /**
         * é‡è¨­ç¢¼è¡¨æˆ–å€’æ•¸è¨ˆæ™‚å™¨
         */
        function resetTimer() {
            clearInterval(timerInterval);
            elapsedTime = 0; // é‡è¨­ç¢¼è¡¨å·²é€æ™‚é–“
            countdownTotalDuration = 0; // é‡è¨­å€’æ•¸ç¸½æ™‚é–“
            countdownRemainingAtPause = 0; // é‡è¨­å€’æ•¸æš«åœæ™‚çš„å‰©é¤˜æ™‚é–“
            isRunning = false;

            if (mode === 'stopwatch') {
                updateDisplayContent(0);
            } else { // countdown mode
                // é‡è¨­å€’æ•¸è¨ˆæ™‚è¼¸å…¥é¡¯ç¤ºç‚º 00:00:00
                countdownHoursDisplay.textContent = '00';
                countdownMinutesDisplay.textContent = '00';
                countdownSecondsDisplay.textContent = '00';
                updateDisplayContent(0); // ä¸»é¡¯ç¤ºå€ä¹Ÿæ­¸é›¶
                // é‡è¨­éµç›¤è¼¸å…¥ç‹€æ…‹ (å·²ç§»é™¤éµç›¤ï¼Œæ‰€ä»¥æ­¤è™•ç„¡å¯¦éš›ä½œç”¨)
                currentInputString = '';
                // hideKeypad(); // å·²ç§»é™¤éµç›¤ï¼Œç„¡éœ€éš±è—
            }
            toggleStartPauseButton.textContent = 'é–‹å§‹'; // é‡è¨­æŒ‰éˆ•æ–‡å­—å’Œé¡è‰²
            toggleStartPauseButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
            toggleStartPauseButton.classList.add('bg-green-600', 'hover:bg-green-700');
            hideMessage(); // éš±è—æ™‚é–“åˆ°è¨Šæ¯
        }

        /**
         * è¨­å®šå€’æ•¸è¨ˆæ™‚æ™‚é–“
         * æ­¤å‡½æ•¸ç¾åœ¨åªè² è²¬æ ¹æ“šè¼¸å…¥æ¡†çš„å€¼æ›´æ–°å…§éƒ¨è®Šæ•¸ `countdownTotalDuration` å’Œ `countdownRemainingAtPause`ã€‚
         */
        function setCountdown() {
            const hours = parseInt(countdownHoursDisplay.textContent) || 0;
            const minutes = parseInt(countdownMinutesDisplay.textContent) || 0;
            const seconds = parseInt(countdownSecondsDisplay.textContent) || 0;

            countdownTotalDuration = (hours * 3600 + minutes * 60 + seconds) * 1000;
            countdownRemainingAtPause = countdownTotalDuration; // è¨­å®šæ–°æ™‚é–“æ™‚ï¼Œå‰©é¤˜æ™‚é–“ç­‰æ–¼ç¸½æ™‚é–“
            updateDisplayContent(countdownTotalDuration); // æ›´æ–°ä¸»é¡¯ç¤ºå€çš„å…§å®¹
        }

        /**
         * é¡¯ç¤ºè¨Šæ¯ï¼ˆä¾‹å¦‚ï¼šæ™‚é–“åˆ°ï¼ï¼‰
         * @param {string} message - è¦é¡¯ç¤ºçš„è¨Šæ¯
         * @param {boolean} autoHide - æ˜¯å¦è‡ªå‹•éš±è—è¨Šæ¯
         */
        function displayMessage(message, autoHide = false) {
            let messageBox = document.getElementById('messageBox');
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'messageBox';
                messageBox.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-700 text-white p-4 rounded-lg shadow-xl z-50 text-lg font-semibold';
                document.body.appendChild(messageBox);
            }
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            if (autoHide) {
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 3000);
            }
        }

        /**
         * éš±è—è¨Šæ¯
         */
        function hideMessage() {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) {
                messageBox.style.display = 'none';
            }
        }

        /**
         * æ›´æ–°æ¨¡å¼é¡¯ç¤ºï¼ˆåˆ‡æ›ç¢¼è¡¨/å€’æ•¸è¨ˆæ™‚å™¨ä»‹é¢ï¼‰
         */
        function updateModeDisplay() {
            if (mode === 'stopwatch') {
                stopwatchSection.classList.remove('hidden');
                countdownSection.classList.add('hidden');
                showStopwatchButton.classList.add('bg-blue-600', 'text-white');
                showStopwatchButton.classList.remove('text-gray-700', 'hover:bg-gray-200');
                showCountdownButton.classList.remove('bg-blue-600', 'text-white');
                showCountdownButton.classList.add('text-gray-700', 'hover:bg-gray-200');
                // é‡è¨­ç¢¼è¡¨é¡¯ç¤º
                updateDisplayContent(elapsedTime);
                // hideKeypad(); // å·²ç§»é™¤éµç›¤ï¼Œç„¡éœ€éš±è—
            } else { // countdown
                stopwatchSection.classList.add('hidden');
                countdownSection.classList.remove('hidden');
                showCountdownButton.classList.add('bg-blue-600', 'text-white');
                showCountdownButton.classList.remove('text-gray-700', 'hover:bg-gray-200');
                showStopwatchButton.classList.remove('bg-blue-600', 'text-white');
                showStopwatchButton.classList.add('text-gray-700', 'hover:bg-gray-200');
                // é‡è¨­å€’æ•¸è¨ˆæ™‚é¡¯ç¤º
                // ç¢ºä¿å€’æ•¸è¨ˆæ™‚è¼¸å…¥å€çš„é¡¯ç¤ºèˆ‡å…§éƒ¨å€¼åŒæ­¥
                countdownHoursDisplay.textContent = String(Math.floor(countdownTotalDuration / 3600000)).padStart(2, '0');
                countdownMinutesDisplay.textContent = String(Math.floor((countdownTotalDuration % 3600000) / 60000)).padStart(2, '0');
                countdownSecondsDisplay.textContent = String(Math.floor((countdownTotalDuration % 60000) / 1000)).padStart(2, '0');
                updateDisplayContent(countdownTotalDuration); // ä¸»é¡¯ç¤ºå€ä¹Ÿæ›´æ–°
                // setActiveInput(countdownHoursDisplay); // å·²ç§»é™¤éµç›¤ï¼Œç„¡éœ€è¨­å®šæ´»å‹•è¼¸å…¥æ¡†
            }
            // æ¯æ¬¡åˆ‡æ›æ¨¡å¼æ™‚ï¼Œç¢ºä¿ç¢¼è¡¨åœæ­¢ä¸¦é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            clearInterval(timerInterval);
            isRunning = false;
            toggleStartPauseButton.textContent = 'é–‹å§‹'; // é‡è¨­ç‚ºé–‹å§‹
            toggleStartPauseButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
            toggleStartPauseButton.classList.add('bg-green-600', 'hover:bg-green-700');
            hideMessage();
        }

        /**
         * åˆ‡æ›æ·ºè‰²/æ·±è‰²æ¨¡å¼
         */
        function toggleTheme() {
            const htmlElement = document.documentElement;
            if (htmlElement.classList.contains('dark')) {
                htmlElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                themeToggleButton.textContent = 'ğŸŒ™'; // æœˆäº®åœ–ç¤ºè¡¨ç¤ºåˆ‡æ›åˆ°æ·±è‰²æ¨¡å¼
            } else {
                htmlElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                themeToggleButton.textContent = 'â˜€ï¸'; // å¤ªé™½åœ–ç¤ºè¡¨ç¤ºåˆ‡æ›åˆ°æ·ºè‰²æ¨¡å¼
            }
        }

        /**
         * è¼‰å…¥ä¸»é¡Œåå¥½è¨­å®š
         */
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleButton.textContent = 'â˜€ï¸';
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleButton.textContent = 'ğŸŒ™';
            }
        }

        /**
         * ç²å–å€’æ•¸è¨ˆæ™‚å»ºè­° (ä½¿ç”¨ Gemini API)
         * æ­¤å‡½æ•¸å·²ç§»é™¤å…¶æŒ‰éˆ•ï¼Œä½†ä¿ç•™å‡½æ•¸é‚è¼¯ä»¥é˜²æœªä¾†éœ€è¦ã€‚
         */
        async function getCountdownSuggestion() {
            const hours = parseInt(countdownHoursDisplay.textContent) || 0;
            const minutes = parseInt(countdownMinutesDisplay.textContent) || 0;
            const seconds = parseInt(countdownSecondsDisplay.textContent) || 0;

            const totalSeconds = (hours * 3600 + minutes * 60 + seconds);

            if (totalSeconds === 0) {
                displayMessage("è«‹å…ˆè¨­å®šå€’æ•¸æ™‚é–“æ‰èƒ½ç²å–å»ºè­°ï¼", true);
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥è¨Šæ¯
            displayMessage("æ­£åœ¨ç²å–å»ºè­°...", false);

            try {
                let prompt = `Given a time duration of ${hours} hours, ${minutes} minutes, and ${seconds} seconds, provide a concise and motivating suggestion for an activity or focus during this time. For example, if it's 30 minutes, suggest a quick workout or reading a chapter. Keep the suggestion to one sentence and make it in Traditional Chinese.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas å°‡è‡ªå‹•æä¾› API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    displayMessage(`å»ºè­°: ${text}`, false); // é¡¯ç¤ºå»ºè­°ï¼Œä¸è‡ªå‹•éš±è—
                } else {
                    displayMessage("æœªèƒ½ç²å–å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", true);
                }
            } catch (error) {
                console.error("Error fetching suggestion:", error);
                displayMessage("ç²å–å»ºè­°æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚", true);
            } finally {
                // æŒ‰éˆ•å·²ç§»é™¤ï¼Œç„¡éœ€å•Ÿç”¨
            }
        }

        // æ•¸å­—å°éµç›¤å’Œç®­é ­æŒ‰éˆ•é‚è¼¯ (æ•¸å­—å°éµç›¤ç›¸é—œé‚è¼¯å·²ç§»é™¤)

        /**
         * è¨­å®šç•¶å‰é¸ä¸­çš„è¼¸å…¥æ¡† (åƒ…ç”¨æ–¼é«˜äº®é¡¯ç¤ºï¼Œä¸æ¶‰åŠéµç›¤)
         * @param {HTMLElement} spanElement - è¦é¸ä¸­çš„ span å…ƒç´ 
         */
        function setActiveInput(spanElement) {
            // ç§»é™¤æ‰€æœ‰è¼¸å…¥æ¡†çš„é¸ä¸­æ¨£å¼
            document.querySelectorAll('.countdown-input-display').forEach(span => {
                span.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500', 'selected-input');
            });
            // ç‚ºé¸ä¸­çš„è¼¸å…¥æ¡†æ·»åŠ æ¨£å¼
            spanElement.classList.add('border-blue-500', 'ring-2', 'ring-blue-500', 'selected-input');
            activeInputSpan = spanElement;
            currentInputString = activeInputSpan.textContent.replace(/^0+/, ''); // ç§»é™¤å‰å°é›¶
            if (currentInputString === '') currentInputString = '0'; // å¦‚æœå…¨æ˜¯é›¶ï¼Œå‰‡è¨­ç‚º '0'
        }

        /**
         * å¢åŠ æˆ–æ¸›å°‘æ™‚é–“å–®ä½çš„å€¼
         * @param {string} unit - æ™‚é–“å–®ä½ ('hours', 'minutes', 'seconds')
         * @param {string} action - 'increment' æˆ– 'decrement'
         */
        function adjustTimeByArrow(unit, action) {
            let targetSpan;
            let limit;
            let currentVal;

            if (unit === 'hours') {
                targetSpan = countdownHoursDisplay;
                limit = 99;
            } else if (unit === 'minutes') {
                targetSpan = countdownMinutesDisplay;
                limit = 59;
            } else if (unit === 'seconds') {
                targetSpan = countdownSecondsDisplay;
                limit = 59;
            } else {
                return;
            }

            currentVal = parseInt(targetSpan.textContent);

            if (action === 'increment') {
                currentVal = (currentVal + 1) > limit ? 0 : (currentVal + 1);
            } else if (action === 'decrement') {
                currentVal = (currentVal - 1) < 0 ? limit : (currentVal - 1);
            }

            targetSpan.textContent = String(currentVal).padStart(2, '0');
            setActiveInput(targetSpan); // ç®­é ­æ“ä½œå¾Œä¹Ÿå°‡è©²å–®ä½è¨­ç‚ºé¸ä¸­
        }


        // ç›£è½æŒ‰éˆ•é»æ“Šäº‹ä»¶
        toggleStartPauseButton.addEventListener('click', toggleStartPause); // åˆä½µå¾Œçš„æŒ‰éˆ•äº‹ä»¶
        resetButton.addEventListener('click', resetTimer);
        showStopwatchButton.addEventListener('click', () => {
            mode = 'stopwatch';
            updateModeDisplay();
            resetTimer(); // ç¢ºä¿åˆ‡æ›æ¨¡å¼æ™‚é‡è¨­ç¢¼è¡¨
        });
        showCountdownButton.addEventListener('click', () => {
            mode = 'countdown';
            updateModeDisplay();
            resetTimer(); // ç¢ºä¿åˆ‡æ›æ¨¡å¼æ™‚é‡è¨­ç¢¼è¡¨
            // åœ¨åˆ‡æ›åˆ°å€’æ•¸è¨ˆæ™‚æ¨¡å¼æ™‚ï¼Œæ ¹æ“šè¼¸å…¥æ¡†çš„ç•¶å‰å€¼è‡ªå‹•è¨­å®šå€’æ•¸æ™‚é–“
            setCountdown();
        });
        themeToggleButton.addEventListener('click', toggleTheme); // ä¸»é¡Œåˆ‡æ›æŒ‰éˆ•äº‹ä»¶

        // ç›£è½å€’æ•¸è¨ˆæ™‚é¡¯ç¤ºå€çš„é»æ“Šäº‹ä»¶ï¼Œç”¨æ–¼é¸ä¸­è¼¸å…¥ç›®æ¨™
        countdownHoursDisplay.addEventListener('click', () => setActiveInput(countdownHoursDisplay));
        countdownMinutesDisplay.addEventListener('click', () => setActiveInput(countdownMinutesDisplay));
        countdownSecondsDisplay.addEventListener('click', () => setActiveInput(countdownSecondsDisplay));

        // ç›£è½ç®­é ­æŒ‰éˆ•é»æ“Šäº‹ä»¶
        document.querySelectorAll('.arrow-button').forEach(button => {
            button.addEventListener('click', (event) => {
                const unit = event.target.dataset.unit;
                const action = event.target.dataset.action;
                adjustTimeByArrow(unit, action);
                // ç®­é ­æ“ä½œå¾Œä¹Ÿè‡ªå‹•æ›´æ–°å€’æ•¸æ™‚é–“
                setCountdown();
            });
        });

        // ç›£è½ document ä¸Šçš„é»æ“Šäº‹ä»¶ï¼Œç”¨æ–¼åœ¨é»æ“Šå¤–éƒ¨æ™‚éš±è—å°éµç›¤ (ç¾åœ¨åªç”¨æ–¼å–æ¶ˆé«˜äº®)
        document.addEventListener('click', (event) => {
            const isClickInsideCountdownInput = event.target.classList.contains('countdown-input-display');
            const isClickInsideArrowButton = event.target.classList.contains('arrow-button');
            const isClickInsideToggleStartPauseButton = toggleStartPauseButton.contains(event.target); // ç¢ºä¿é»æ“Šé–‹å§‹/æš«åœæŒ‰éˆ•æ™‚ä¸å–æ¶ˆé«˜äº®
            const isClickInsideResetButton = resetButton.contains(event.target); // ç¢ºä¿é»æ“Šé‡è¨­æŒ‰éˆ•æ™‚ä¸å–æ¶ˆé«˜äº®

            // æª¢æŸ¥é»æ“Šæ˜¯å¦åœ¨å€’æ•¸è¨ˆæ™‚æ¨¡å¼ä¸‹ï¼Œä¸¦ä¸”é»æ“Šçš„ç›®æ¨™ä¸åœ¨å€’æ•¸è¼¸å…¥æ¡†ã€ç®­é ­æŒ‰éˆ•ã€é–‹å§‹/æš«åœæŒ‰éˆ•æˆ–é‡è¨­æŒ‰éˆ•å…§éƒ¨
            if (mode === 'countdown' && !isClickInsideCountdownInput && !isClickInsideArrowButton && !isClickInsideToggleStartPauseButton && !isClickInsideResetButton) {
                // ç§»é™¤æ‰€æœ‰è¼¸å…¥æ¡†çš„é¸ä¸­æ¨£å¼
                document.querySelectorAll('.countdown-input-display').forEach(span => {
                    span.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500', 'selected-input');
                });
                activeInputSpan = null; // ä¸å†æœ‰æ´»å‹•è¼¸å…¥æ¡†
                currentInputString = ''; // æ¸…é™¤è¼¸å…¥å­—ä¸²
            }
        });


        // åˆå§‹åŒ–æ™‚ç¦ç”¨æš«åœæŒ‰éˆ•ä¸¦é¡¯ç¤ºç¢¼è¡¨æ¨¡å¼
        updateModeDisplay(); // é¦–æ¬¡è¼‰å…¥æ™‚é¡¯ç¤ºç¢¼è¡¨æ¨¡å¼
        loadTheme(); // è¼‰å…¥ä¸»é¡Œåå¥½è¨­å®š
        // é¦–æ¬¡è¼‰å…¥å€’æ•¸è¨ˆæ™‚æ¨¡å¼æ™‚ï¼Œé è¨­é¸ä¸­å°æ™‚è¼¸å…¥ä¸¦è¨­å®šå€’æ•¸æ™‚é–“
        if (mode === 'countdown') {
            setActiveInput(countdownHoursDisplay); // ä»ç„¶é«˜äº®å°æ™‚è¼¸å…¥
            setCountdown(); // ç¢ºä¿å€’æ•¸è¨ˆæ™‚æ¨¡å¼åˆå§‹é¡¯ç¤ºæ­£ç¢º
        }
    </script>
</body>
</html>